# Диздок по игре

## сеттинг

Средневековье, магия, темнейшие подземелья.

## ключевые фичи

- командные прохождения подземелий
- развитие истории в кооперативном режиме*

\* - освобождение НПС из подземелий, торговля с этими НПС, улучшение стартовых предметов, усложнение подземелий!

---

## Гильдии

При старте игры игроку предлагается выбрать молодую гильдию или создать свою собственную, пригласив друзей.

Вступить в гильдию можно только с разрешения главы гильдии.
Глава гильдии назначается при создании гильдии.
Глава может передать свои полномочия любому другому участнику гильдии в любое время.

Минимальное количество игроков в гильдии - 3, максимальное - 10. [очень условно]

Если игрок захочет перейти в другую гильдию, он сможет сделать это только при выполнении следующих условий:

- прошло более [недели(условно)] с момента последнего перехода в другую гильдию
- <del> ранг другой гильдии* не должен отличаться от ранга текущей</del>
- количество участников текущей гильдии более 3
- количество участников другой гильдии менее 10

<del>\* - ранг - условная мера прогресса в истории (какие НПС были освобождены, сколько подземелий было пройдено и т.п.)</del>

Гильдия может быть расформирована в случае, если все ее участники с этим согласны.
При этом участники сами выбирают себе новую гильдию для вступления.

### Вступление в гильдию

При вступлении в гильдию список доступных гильдий можно сортировать по трем критериям:

- по алфавиту,
- по количеству участников,
- по **степени активности**.

**Степень активности гильдии** рассчитывается как среднее количество человеко-походов совершенных за один день (неважно успешных или нет).

Глава гильдии может объявить свою гильдию **закрытой** (по-умолчанию она считается **открытой**).
В этом случае она исчезнет из списка доступных для вступления гильдий, а все ожидающие заявки будут отклонены.

### Выход из гильдии

Моментальный выход из гильдии может быть осуществлен только если:

- с момента вступления в гильдию прошло более суток.

---

## Виды подземелий и их генерация

### Обычные подземелья

Наиболее распространены **обычные** подземелья, структура которых состоит из нескольких этажей, на каждом из которых в случайном порядке генерируются следующие типы комнат:

- комната с врагами
- комната с ловушкой(-ами)
- комната с сокровищами
- сюжетная комната*
- комната отдыха (всегда располагается перед боссом)
- комната с боссом (всегда располагается последней)

\* - сюжетная комната очень редкая.
В ней может быть заключен НПС, или она может содержать особые предметы для сюжетных комнат в последующих этажах текущего подземелья.

Количество этажей, а также комнат каждого типа варьируется в зависимости от сложности подземелья.

При прохождении игроками такого подземелья комнаты проходятся последовательно без возможности пропуска или возврата.
Допускается побег:

- одним участником команды во время сражения с монстрами (но не с боссом),
- всеми участниками в команатах сокровищ и комнатах отдыха.

При побеге <del>все</del> примерно половина снаряжения игроков, а также собранные ключевые предметы теряются (ведь бежать нужно налегке). Доля потерянных предметов изначально составляет 80% и уменьшается с каждой прокачкой **удачи** и **внимательности** (до 40%).

При побеге также не могут быть спасены новые НИПы.

---

#### Алгоритм генерации обычного подземелья

В качестве входных данных алгоритму требуются:

- $N$ - состав команды (количество игроков),
- $R$ - ранг гильдии (для команды из одной гильдии) / средний ранг гильдий участников,
- $C$ - среднее количество пройденных подземелий среди всех участников похода.

<span style=color:blue>[1.]</span> Определяется общее число этажей по формуле:

$$F_{Count} = \left[\mathrm{lerp}\left(F_{Min}, F_{Max}, \tanh\left(k\left(\frac{N}{N_{opt}}+\frac{R}{R_{opt}}+\frac{C}{C_{opt}}\right)\right)\right)\right],$$

где

- $F_{Min}, F_{Max}$ - минимальное и максимальное число этажей;
- $N_{opt} = 4$ - оптимальное число игроков для одного похода;
- $R_{opt}$ - оптимальный ранг для достижения существенного прогресса (нахождения 25% НИПов, например);
- $C_{opt}$ - оптимальное количество пройденных подземелий;
- $k = 0.5$ - нормировочный коэффициент;
- $\tanh(x)$ - гиперболический тангенс;
- $\mathrm{lerp}(a, b, t) := a + (b - a) * t$ - линейная интерполяция;
- $[x]$ - оператор округления.


<span style=color:blue>[2.]</span> Определяется число комнат на этаже $F_i: i \in [0; F_{Count})$ по формуле:

$$R_{Count} = \left[\mathrm{lerp}\left(R_{Min}, R_{Max}, \frac{1}{3}\log_2\left(1+\frac{i}{2}+\frac{2N}{N_{opt}}+\frac{R}{R_{opt}}+\frac{C}{C_{opt}}\right)\right)\right],$$

где

- $R_{Min}, R_{Max}$ - минимальное и максимальное<sup>1</sup> число комнат на этаже.

<sup>1</sup> на самом деле формула допускает генерацию большего числа комнат, чем $R_{Max}$.

<span style=color:blue>[3.]</span> Определение типовых комнат на каждом этаже:

1. последняя комната этажа генерируется как комната с боссом;
2. предпоследняя комната этажа генерируется как комната отдыха;
3. из оставшихся, одна случайная комната помечается как сокровищница;
4. из оставшихся, одна комната помечается как комната с ловушками;
5. для каждой из оставшихся комнат выполняется следующее:
    1. рассчитываются коэффициенты $X$, $Y$ и $Z$:
    $$\left\{\begin{array}{l}
        X = \mathrm{clamp}(0,10 + N - R_{treasure}, 14) \\
        Y = \mathrm{clamp}(0,2 + C - R_{trap}, 8) \\
        Z = \mathrm{clamp}(0,30 + i - R_{enemy}, 40)
    \end{array}\right.,$$
    2. проводится розыгрыш, в котором на основании рассчитанных коэффициентов выбирается тип очередной комнаты ($X$ - сокровищница, $Y$ - комната с ловушками, $Z$ - комната с монстрами),
    3. генерируется комната в соответствии с назначенным типом,

Где в формулах:

- $i$ - индекс этажа (от нуля);
- $R_{treasure}$ - количество уже сгенерированных сокровищниц на данном этаже;
- $R_{trap}$ - количество уже сгенерированных комнат с ловушками на данном этаже;
- $R_{enemy}$ - количество уже сгенерированных комнат с монстрами на данном этаже.

<span style=color:blue>[4.]</span> Генерация сюжетных вставок (при условии, что участники похода состоят в одной гильдии)

1. Вычисляется вероятность нахождения НИПа во всем подземелье по формуле:

$$P_{NPC} = \frac{1}{2} + \frac{1}{2}\tanh\left(\ln\left(\frac{1}{3}\max\left(0, \frac{C}{C_{opt}} - \frac{R}{R_{opt}}\right)\right)\right).$$

2. С вычисленной вероятностью в подземелье на случайный этаж добавляется НИП. Вероятность добавления НИПа на $i$-ый этаж рассчитывается как:

$$P_i = \frac{2i}{F_{Count} (F_{Count} - 1)}.$$

3. В выбранном этаже случайная комната (любая, кроме комнаты отдыха и комнаты с боссом) заменяется на комнату с НИПом.

---

### Подземелье неистовства

Все тоже самое, что и в обычном подземелье, за исключением отсутствия комнат с сокровищами и комнат отдыха.

### Лабиринт тьмы

В лабиринте тьмы добавляется выбор пути в подземелье (следующей комнаты для посещения) и счетчик оставшихся ходов (факел).
Один из игроков на входе обязан взять факел и нести его всю дорогу (возможно вместо основного оружия).

Лабиринт тьмы является одним большим подземельем, переходы между комнатами которого генерируются при создании гильдии и впоследствии не изменяются (меняется только "наполнение" комнат).
Сам лабиринт же разделен на секции, разделенные особыми комнатами, которые позволяют передохнуть игрокам и зажечь факел (обновить счетчик) для следующей секции.

При смерти всех игроков (или истечении таймера факела) прогресс, совершенный в лабиринте тьмы сохраняется, но следующий поход все равно начинается с первой секции.

---

## Режим боевки в подземельях

Боевка осуществляется в пошаговом режиме.

Перед началом похода игроками определяется строй.
Строй влияет на очередность ходов среди игроков.
Строй также можно изменить в комнатах отдыха.

В начале боя случайным образом фиксируется очередность ходов среди игроков и врагов с учетом строя.

Во время своего хода игрок может атаковать врага. После атаки ход переходит другому игроку/врагу.

Опции, которые могут быть применены **без потери хода**:

- использование зелья

---

## Смерть в подземелье

После смерти в подземелье игрок может возродиться в лобби.
При возрождении все собранные предметы пропадают.
Также, за возрождение необходимо отдать 10% от накопленных денег.

При прохождении всего подземелья все собранные предметы остаются вместе с игроком для дальнейшей продажи торговцам (НПС).

---

## Подбираемые предметы

Все подбираемые предметы в подземельях делятся на категории:

- оружие
    - ближнего боя: мечи, дубины, палицы, топоры и тп
    - дальнего боя: луки, арбалеты и тп
    - магическое: посохи, книги заклинаний и тп
    - метательное: метательные ножи, томогавки и тп
- броня
    - кираса
    - налядвяники
    - шлем
    - перчатки
    - ботинки
- зелья
    - зелье восстановления здоровья
    - зелья, накладывающие определенные эффекты
    - зелья, повышающие характеристики персонажа на время прохождения подземелья
- особое (сюжетное)
    - инструменты плотника (нужны плотнику для строительства)
    - драгоценные камни (для ювилира)
    - зачарованные камни (используются у шамана для увеличения характеристик персонажей)
- амулеты (могут быть получены у ювилира, но могут с маленьким шансом появиться в комнате сокровищ)

Каждый подбираемый предмет имеет **вес**.

Оружие можно нести в количестве не более 2 штук.

Каждый элемент брони можно нести не более чем в одном экземпляре.

Суммарно количество переносимых зелий не должно превышать 3 штук.
(Но можно купить специальный пояс у продовца зелий, который увеличит это число до 4/5).

---

## Стартовые предметы

Перед входом в подземелья игрокам предлагается выбрать стартовое оружие.
Игроки вправе отказаться и идти либо с оружием, добытым из предыдущих подземелий, либо с кулаками...

---

## НПС

Изначально есть только 2 НПС:

- барахольщик (предлагает на выбор оружие на входе в подземелья)
- некто по прозвищу Харон (возраждает после смерти в подземелье)

Виды НПС, которых можно спасти из подземелья:

- торговец (позволяет продавать товар)
- оружейник (продает холодное оружие)
- бронник (продает доспехи)
- [ренжевик(название не придумано)] (продает оружие дальнего боя)
- боевой чародей (продает магическое оружие)
- колдун (дает бафы перед походами)
- шаман (улучшает характеристики игроков за зачарованые камни)
- крестьяне (повышают общий ранг гильдии и нужны для продвижения истории)
- продавец зелий (покупает зелья дороже, а также продает зелья)
- инквизитор (выдает задания на охоту за головами существ)
- плотник (осуществляет постройку различных сооружений за материалы из подземелий)
- ювелир (принимает драгоценные камни найденные в подземельях и создает из них / продает **амулеты**)

Спасение НПС осуществляется обнаружением одного в подземелье и последующем успешном прохождении подземелья с этим НПС.

При обнаружении НПС, он присоединяется к команде и участвует в последующих боевках (однако не получает ход, но может быть убит врагами).

За один поход нельзя встретить более одного НПС.

---

## Характеристики игрока

Каждый игрок обладает следующими характеристиками:

- сила (увеличение максимально переносимого веса)
- выносливость (увеличение макс хп)
- метоболизм (увеличение естественной регенерации) ---
- удача (увеличение шанса крит удара)
- внимательность (шанс найти дополнительные сокровища)

Характеристики игрока **перманентны** (не сбрасываются после смерти).

Увеличение характеристик осуществляется у шамана за зачарованные камни.

---

## Эффекты

Эффекты длятся в рамках одного боя.
Каждый эффект может иметь длительность равную фиксированному количеству **ходов существа, которое несет данный эффект**, или до конца боя.
Количество разных эффектов для одного существа не ограничено.

Если накладываемый эффект уже присутствует у существа, то второй эффект не накладывается, а время действия имеющегося продливается до наибольшей длительности среди этих двух эффектов.
Для эффектов с количественными параметрами значение параметров также принимается как максимум из значений обоих эффектов.

Некоторые эффекты имеют противоположные свойства.
При попытке наложения эффекта, противоположного тому, который уже имеется у существа оба эффекта "нейтрализуются" и удаляются с существа вне зависимости от их длительности или количественных параметров.

В случае, если эффект накладывается постоянно (посредством амулета, например), противоположный эффект не может быть наложен.

### Особые эффекты:

| Эффект | Описание | Заменяет эффект |
| --- | --- | --- |
| проворность   | дополнительный ход                         | |
| оглушение     | пропуск хода                               | проворность |
| маскировка    | следующие атаки игнорируют данное существо | |
| провокация    | следующие атаки врагов по данному существу | маскировка |
| проклятие     | шанс быть убитым от любого удара           | |
| благословение | иммунитет к проклятию                      | проклятие |

Особые эффекты не имеют противоположных.
Вместо этого некоторые из них могут заменять противоположные по смыслу эффекты, указанные в таблице.

Если имеется заменяющий эффект, то заменяемый не накладывается.
(Например, если уже есть эффект оглушение, то проворность не накладывается).

### Эффекты, влияющие на защиту/наносимый урон:

| Эффект | Описание | Противоположный эффект |
| --- | --- | --- |
| слабость     | уменьшение атаки         | бодрость     |
| бодрость     | увеличение атаки         | слабость     |
| хрупкость    | уменьшение защиты        | стойкость    |
| стойкость    | увеличение защиты        | хрупкость    |
| рассеянность | увеличение шанса промаха | концентрация |
| концентрация | уменьшение шанса промаха | рассеянность |
| страх        | уменьшение шанса крита   | бесстрашие   |
| бесстрашие   | увеличение шанса крита   | страх        |

Количественное значение эффектов выражается в множителе, который учитывается при подсчете наносимого/получаемого урона.

### Эффекты, влияющие на характеристики игрока:

| Эффект | Описание | Противоположный эффект |
| --- | --- | --- |
| регенерация  | +хп каждый ход | кровотечение |
| кровотечение | -хп каждый ход | регенерация  |
| горение      | -хп каждый ход | обморожение  |
| обморожение  | -хп каждый ход | горение      |
